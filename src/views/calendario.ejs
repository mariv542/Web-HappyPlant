<h2 class="fw-bold mb-3">Calendario de Riego</h2>

<div class="row g-3">
  <!-- Formulario para agregar riego -->
  <div class="col-md-4">
    <form action="/calendario" method="POST">
      <label class="form-label">Agregar riego</label>
      <input type="date" id="fechaRiego" name="dia" class="form-control mb-2" required />
      <input type="time" name="hora" class="form-control mb-2" required />
      <button type="submit" class="btn btn-success w-100">Agregar</button>
    </form>
  </div>

  <!-- Calendario visual -->
  <div class="col-md-8">
    <div class="bg-white border rounded p-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="prevMonth" class="btn btn-outline-success btn-sm">‚¨ÖÔ∏è</button>
        <h5 id="monthYear" class="fw-bold mb-0 text-center flex-grow-1"></h5>
        <button id="nextMonth" class="btn btn-outline-success btn-sm">‚û°Ô∏è</button>
      </div>
      <div id="calendar" class="calendar-grid"></div>
    </div>
  </div>
</div>

<!-- Listado de riegos programados -->
<div class="mt-4">
  <h5>Listado de riegos programados</h5>
  <table class="table table-bordered">
    <thead class="table-light">
      <tr>
        <th>Fecha</th>
        <th>Hora</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <% if(calendario && calendario.length > 0) { %>
        <% calendario.forEach(c => { %>
          <tr>
            <td><%= c.dia %></td>
            <td><%= c.hora %></td>
            <td class="text-center">

              <!-- Formulario para editar -->
              <form action="/calendario/editar/<%= c._id %>" method="POST" class="d-inline">
                <input type="date" name="dia" value="<%= c.dia %>" class="form-control form-control-sm d-inline w-auto" required />
                <input type="time" name="hora" value="<%= c.hora %>" class="form-control form-control-sm d-inline w-auto" required />
                <button type="submit" class="btn btn-warning btn-sm">Modificar</button>
              </form>

              <!-- Formulario para eliminar -->
              <form action="/calendario/eliminar/<%= c._id %>" method="POST" class="d-inline" 
                    onsubmit="return confirm('¬øSeguro que deseas eliminar este riego?');">
                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
              </form>

            </td>
          </tr>
        <% }) %>
      <% } else { %>
        <tr>
          <td colspan="3" class="text-center">No hay riegos programados</td>
        </tr>
      <% } %>
    </tbody>
  </table>
</div>

<!-- Script del calendario -->
<script>
  // ‚úÖ Cargar los datos del calendario desde EJS
  const calendario = JSON.parse('<%- JSON.stringify(calendario || []) %>');

  const calendarEl = document.getElementById("calendar");
  const monthYearEl = document.getElementById("monthYear");
  const prevBtn = document.getElementById("prevMonth");
  const nextBtn = document.getElementById("nextMonth");
  const inputFecha = document.getElementById("fechaRiego");

  let today = new Date();
  let currentMonth = today.getMonth();
  let currentYear = today.getFullYear();

  const monthNames = [
    "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
    "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
  ];

  function renderCalendar(year, month) {
    calendarEl.innerHTML = "";
    monthYearEl.textContent = `${monthNames[month]} ${year}`;

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const firstDayIndex = firstDay.getDay(); // 0=domingo

    let daysHTML = `
      <div class="d-grid fw-bold text-center mb-2" 
           style="grid-template-columns: repeat(7, 1fr);">
        <div class="text-danger">D</div>
        <div>L</div><div>M</div><div>M</div>
        <div>J</div><div>V</div><div class="text-primary">S</div>
      </div>
      <div class="d-grid" style="grid-template-columns: repeat(7, 1fr); text-align:center;">
    `;

    // Espacios antes del primer d√≠a
    for (let i = 0; i < firstDayIndex; i++) {
      daysHTML += `<div></div>`;
    }

    // D√≠as del mes
    for (let d = 1; d <= lastDay.getDate(); d++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
      const isRiego = calendario.some(c => c.dia === dateStr);

      daysHTML += `
        <div class="p-2 border rounded m-1 ${isRiego ? 'bg-success text-white' : ''}" 
             data-date="${dateStr}" 
             style="min-height:60px; cursor:pointer;">
          <div>${d}</div>
          ${isRiego ? '<small>üíß</small>' : ''}
        </div>`;
    }

    daysHTML += "</div>";
    calendarEl.innerHTML = daysHTML;

    // ‚ûï A√±adir eventos de clic a los d√≠as
    document.querySelectorAll("#calendar [data-date]").forEach(day => {
      day.addEventListener("click", () => {
        const selectedDate = day.getAttribute("data-date");
        inputFecha.value = selectedDate;
        // Peque√±a animaci√≥n visual
        day.classList.add("bg-info", "text-white");
        setTimeout(() => day.classList.remove("bg-info", "text-white"), 500);
      });
    });
  }

  // Navegaci√≥n entre meses
  prevBtn.addEventListener("click", () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar(currentYear, currentMonth);
  });

  nextBtn.addEventListener("click", () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar(currentYear, currentMonth);
  });

  // Inicializaci√≥n
  renderCalendar(currentYear, currentMonth);
</script>

<style>
  #calendar .border {
    transition: all 0.2s;
  }
  #calendar .border:hover {
    background-color: #d1e7dd;
  }
</style>
