<h2 class="fw-bold mb-4 text-center">Monitoreo de Sensores</h2>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="bg-white border rounded shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="text-primary m-0">Sensores</h5>

          <!-- ‚≠ê BOT√ìN CELESTE REGAR PLANTA -->
          <button id="btnForzar" 
                  class="btn fw-bold"
                  style="
                    background-color: #4dc8ff;
                    color: white;
                    border: none;
                    padding: 10px 18px;
                    border-radius: 8px;
                    box-shadow: 0 2px 6px rgba(0, 150, 255, 0.35);
                    transition: 0.2s;
                  "
                  onmouseover="this.style.backgroundColor='#35bfff'"
                  onmouseout="this.style.backgroundColor='#4dc8ff'">
            üíß Regar Planta
          </button>
        </div>

        <table class="table table-bordered text-center align-middle fs-5" style="min-width: 700px;">
          <thead class="table-info">
            <tr style="height: 60px;">
              <th>Sensor</th>
              <th>Valor actual</th>
              <th>Valor anterior</th>
              <th>Estado</th>
              <th>Heatcheck</th>
            </tr>
          </thead>
          <tbody>
            <tr style="height: 60px;">
              <td>üå°Ô∏è Temperatura</td>
              <td id="tempValor" class="fw-semibold">-- ¬∞C</td>
              <td id="tempAnterior" class="fw-semibold">-- ¬∞C</td>
              <td class="text-success fw-bold">Activo</td>
              <td>
                <div class="progress heatcheck">
                  <div id="barraTemp" class="progress-bar bg-info" style="width: 0%; transition: width 0.6s;"></div>
                </div>
              </td>
            </tr>
            <tr style="height: 60px;">
              <td>üíß Humedad</td>
              <td id="humValor" class="fw-semibold">-- %</td>
              <td id="humAnterior" class="fw-semibold">-- %</td>
              <td class="text-success fw-bold">Activo</td>
              <td>
                <div class="progress heatcheck">
                  <div id="barraHum" class="progress-bar bg-info" style="width: 0%; transition: width 0.6s;"></div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

      </div>
    </div>
  </div>
</div>

<style>
.heatcheck { 
  height: 20px; 
  border-radius: 10px; 
  overflow: hidden; 
}
.progress-bar { 
  font-size: 0.9rem; 
  font-weight: bold; 
  color: white; 
  text-align: center;
}
.bg-cold { background-color: #00bcd4 !important; }
.bg-normal { background-color: #4caf50 !important; }
.bg-hot { background-color: #ff9800 !important; }
.bg-danger { background-color: #f44336 !important; }
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

let tempAnterior = 0;
let tempActual = 0;
let humAnterior = 0;
let humActual = 0;

// ‚≠ê BOT√ìN PARA ALTERAR LOS VALORES
document.getElementById("btnForzar").addEventListener("click", () => {
  console.log("üî• Enviando /monitoreo/forzar ...");

  fetch("/monitoreo/forzar", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      console.log("üî• Modo alteraci√≥n activado:", data);
    })
    .catch(err => console.error("‚ùå Error al forzar cambio:", err));
});

// ‚≠ê FUNCI√ìN PARA ACTUALIZAR BARRAS
function actualizarHeatcheck(temp, hum) {
  const barraTemp = document.getElementById("barraTemp");

  // üå°Ô∏è COLORES SEG√öN TEMPERATURA
  let claseTemp = "bg-normal";
  if (temp < 10) claseTemp = "bg-cold";
  else if (temp < 25) claseTemp = "bg-normal";
  else if (temp < 35) claseTemp = "bg-hot";
  else claseTemp = "bg-danger";

  // üéöÔ∏è RANGO -5¬∞ a 50¬∞
  const minTemp = -5;
  const maxTemp = 50;

  let porcentajeTemp = ((temp - minTemp) / (maxTemp - minTemp)) * 100;
  porcentajeTemp = Math.max(0, Math.min(100, porcentajeTemp));

  barraTemp.className = `progress-bar ${claseTemp}`;
  barraTemp.style.width = `${porcentajeTemp}%`;
  barraTemp.innerText = `${temp.toFixed(1)}¬∞C`;

  const barraHum = document.getElementById("barraHum");

  let claseHum = "bg-normal";
  if (hum < 35) claseHum = "bg-cold";
  else if (hum < 70) claseHum = "bg-normal";
  else if (hum < 85) claseHum = "bg-hot";
  else claseHum = "bg-danger";

  barraHum.className = `progress-bar ${claseHum}`;
  barraHum.style.width = `${hum}%`;
  barraHum.innerText = `${hum.toFixed(1)}%`;
}

// ‚≠ê SOCKET RECIBE DATOS DEL SERVIDOR
socket.on("actualizarSensores", data => {
  console.log("üì° Datos recibidos:", data);

  tempAnterior = tempActual;
  humAnterior = humActual;

  tempActual = parseFloat(data.temperatura);
  humActual = parseFloat(data.humedad);

  document.getElementById("tempValor").innerText = `${tempActual.toFixed(1)} ¬∞C`;
  document.getElementById("tempAnterior").innerText = `${tempAnterior.toFixed(1)} ¬∞C`;
  document.getElementById("humValor").innerText = `${humActual.toFixed(1)} %`;
  document.getElementById("humAnterior").innerText = `${humAnterior.toFixed(1)} %`;

  actualizarHeatcheck(tempActual, humActual);
});
</script>
